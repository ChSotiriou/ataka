import typer

from typing import List
from player_cli.ctfconfig_wrapper import STATIC_EXCLUSIONS, get_all_target_ips
from player_cli.util import request, check_response, greenify, redify, WARN_STR, ERROR_STR


app = typer.Typer()


def _print_exploit_targets(history_id, indent=0):
    indent = ' ' * indent

    resp = request('GET', f'exploit_history/{history_id}/exclusions')
    check_response(resp)

    exclude_ips = set(resp['target_ips'])
    for ip in sorted(get_all_target_ips() | exclude_ips):
        if ip in STATIC_EXCLUSIONS:
            continue
        status = redify('OFF') if ip in exclude_ips else greenify('ON ')
        typer.echo(f'{indent}{status} {ip}')


@app.command('ls', help='List exploit targets.')
def exploit_target_ls(
    history_id: str = typer.Argument(..., help='History ID.')
):
    _print_exploit_targets(history_id)


@app.command('on', help='Turn on exploit targets.')
def exploit_target_on(
    history_id: str = typer.Argument(..., help='History ID.'),
    target_ips: List[str] = typer.Argument(None, help='Target IP(s).'),
    all_flag: bool = typer.Option(False, '--all', help='Turn on all targets.')
):
    target_ips = set(target_ips)

    if all_flag and target_ips:
        typer.echo(f'{ERROR_STR}: you specified both --all and target IP(s), this is probably a mistake')
        raise typer.Exit(code=1)
    if not all_flag and not target_ips:
        typer.echo(f'{ERROR_STR}: no target IP(s) specified (did you want --all?)')
        raise typer.Exit(code=1)

    if not all_flag:
        all_ips = get_all_target_ips()
        for ip in target_ips:
            if ip in STATIC_EXCLUSIONS:
                typer.echo(f'{WARN_STR}: ignoring target {ip} (static exclusion)')
            elif ip not in all_ips:
                typer.echo(f'{WARN_STR}: unknown target {ip}')

    resp = request('GET', f'exploit_history/{history_id}/exclusions')
    check_response(resp)

    exclude_ips = set(resp['target_ips'])
    if all_flag:
        new_exclude_ips = set()
    else:
        new_exclude_ips = exclude_ips - (target_ips - STATIC_EXCLUSIONS)

    if new_exclude_ips != exclude_ips:
        check_response(
            request('PUT', f'exploit_history/{history_id}/exclusions', data={
                'target_ips': list(new_exclude_ips),
            })
        )

    exploit_target_ls(history_id)


@app.command('off', help='Turn off exploit targets.')
def exploit_target_off(
    history_id: str = typer.Argument(..., help='History ID.'),
    target_ips: List[str] = typer.Argument(None, help='Target IP(s).'),
    all_flag: bool = typer.Option(False, '--all', help='Turn on all targets.'),
    force: bool = typer.Option(False, '--force', help=
        'Allow exclusion of unknown targets.')
):
    target_ips = set(target_ips)

    if all_flag and target_ips:
        typer.echo(f'{ERROR_STR}: you specified both --all and target IP(s), this is probably a mistake')
        raise typer.Exit(code=1)
    if not all_flag and not target_ips:
        typer.echo(f'{ERROR_STR}: no target IP(s) specified (did you want --all?)')
        raise typer.Exit(code=1)

    all_ips = get_all_target_ips()
    if all_flag:
        target_ips = all_ips
    else:
        for ip in target_ips:
            if ip in STATIC_EXCLUSIONS:
                typer.echo(f'{WARN_STR}: ignoring target {ip} (static exclusion)')
            elif ip not in all_ips:
                if force:
                    typer.echo(f'{WARN_STR}: unknown target {ip} (proceeding anyway)')
                else:
                    typer.echo(f'{ERROR_STR}: unknown target {ip} (use --force to exclude anyway)')
                    raise typer.Exit(code=1)

    resp = request('GET', f'exploit_history/{history_id}/exclusions')
    check_response(resp)

    exclude_ips = set(resp['target_ips'])
    new_exclude_ips = exclude_ips | (target_ips - STATIC_EXCLUSIONS)

    if new_exclude_ips != exclude_ips:
        check_response(
            request('PUT', f'exploit_history/{history_id}/exclusions', data={
                'target_ips': list(new_exclude_ips),
            })
        )

    exploit_target_ls(history_id)
