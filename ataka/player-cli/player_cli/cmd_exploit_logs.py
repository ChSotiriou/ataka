import typer

from typing import List
from player_cli.cmd_exploit import app, _get_histories, EXECUTION_STATUS_IS_FINAL, EXECUTION_STATUS_COLOR, \
    _print_exploit_execution
from player_cli.util import (
    request, dt_from_iso,
    ERROR_STR, WARN_STR
)


@app.command('logs', help='Show remote exploit logs.')
def exploit_logs(
        cmd_ids: List[str] = typer.Argument(..., metavar='EXPLOIT_ID...', help=
        'Exploit ID or history ID. '
        'If an exploit ID is specified, shows logs for that exploit. '
        'If a history ID is specified, shows logs for the active exploits in the history. '
        'You can specify multiple IDs and mix exploit and history IDs.'),
        limit: int = typer.Option(1, '-n', '--num', metavar='NUM', help=
        'Show logs for the last NUM ticks.')
):
    histories = _get_histories()
    all_exploit_ids = set(x['id'] for h in histories.values() for x in h['exploits'])

    exploit_ids = set()

    for cur_id in cmd_ids:
        if cur_id in histories:
            found = False
            for exploit in histories[cur_id]['exploits']:
                if exploit['active']:
                    exploit_ids.add(exploit['id'])
                    found = True
            if not found:
                typer.echo(f'{WARN_STR}: no active exploit in history "{cur_id}"')
        else:
            if cur_id not in all_exploit_ids:
                typer.echo(f'{ERROR_STR}: exploit "{cur_id}" does not exist')
                raise typer.Exit(code=1)
            exploit_ids.add(cur_id)

    exploit_ids = list(sorted(exploit_ids))

    typer.echo(f'Showing logs for exploits: {", ".join(exploit_ids)}')
    typer.echo()

    job_items = []
    for exploit_id in exploit_ids:
        exploit_items = request('GET', f'exploit/{exploit_id}/jobs', params={
            'limit': limit,
        })
        for item in exploit_items:
            item['job']['timestamp'] = dt_from_iso(item['job']['timestamp'])
        job_items += exploit_items

    job_items.sort(key=lambda x: x['job']['timestamp'])

    for item in job_items:
        job = item['job']
        for execution in item['executions']:
            _print_exploit_execution(job, execution)
